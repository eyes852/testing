name: GitHub Actions Demo
run-name: ${{ github.actor }} is testing out GitHub Actions ðŸš€
on: [push]
jobs:
  Run-Preflight:
    runs-on: ubuntu-20.04
    steps:
      - uses: docker/login-action@v1
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}
      - run: mkdir -p /tmp/preflight-artifacts
      - run: |-
          docker run \
          -i \
          --rm \
          --security-opt=label=disable \
          --env PFLT_LOGLEVEL=info \
          --env PFLT_ARTIFACTS=/artifacts \
          -v /tmp/preflight-artifacts:/artifacts \
          quay.io/opdev/preflight:stable check container ghcr.io/loxilb-io/kube-loxilb-ubi8:latest
      - name: get results.json
        id: get_results_json
        run: |
          RESULT=$(cat /tmp/preflight-artifacts/results.json)
          PASSED=${{ fromJSON(RESULT) }}.passed
          echo "PASSED=${{ PASSED }}" >> $GITHUB_OUTPUT
      - if: ${{ fromJSON(steps.get_results_json.outputs.PASSED) == true }}
        run: |
          echo "what the hell passed: true."
      - if: ${{ fromJSON(steps.get_results_json.outputs.RESULT).passed != true }}
        run: |
          echo "passed: false"
          cat /tmp/preflight-artifacts/results.json
          exit 1
